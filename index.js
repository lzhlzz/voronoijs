function import$(t,n){var e={}.hasOwnProperty;for(var r in n)e.call(n,r)&&(t[r]=n[r]);return t}function in$(t,n){for(var e=-1,r=n.length>>>0;++e<r;)if(t===n[e])return!0;return!1}var Aux,Convex;Aux={inner:function(t,n){return["x","y","z"].map(function(e){return t[e]*n[e]}).reduce(function(t,n){return t+n},0)},side:function(t,n){var e;return e=this.inner(t.norm,n)},sub:function(t,n){var e;return e={},["x","y","z"].map(function(r){return e[r]=t[r]-n[r]}),e},cross:function(t,n){return{x:t.y*n.z-t.z*n.y,y:t.z*n.x-t.x*n.z,z:t.x*n.y-t.y*n.x}}},Convex=function(t,n){function e(t){return d.center[t]=[0,1,2,3].reduce(function(n,e){return n+d.pts[u[e]][t]},0)/4}function r(t){return t.map(function(t){return u[t]})}function i(t){return t.trivial}function o(t,n){var e;return e=Aux.sub(d.center,d.pts[t]),["x","y","z"].reduce(function(t,n){return t+Math.pow(e[n],2)},0),[e,n]}function s(t,n){return t[0]-n[0]}var a,u,c,l,h,f,p,d=this;if(this.pts=t,this.debug=n,this.faces.list=[],this.debug&&console.log("Create convex for point set ( length "+t.length+" )"),!(this.pts.length<4)){for(a=[[0,1,2,3],3],u=a[0],this.idx=a[1];this.idx<this.pts.length;){for(this.idx++,this.center={},["x","y","z"].map(e),l=[],h=0,f=(a=[[0,1,2],[0,1,3],[0,2,3],[1,2,3]].map(r)).length;f>h;++h)p=a[h],l.push(new Convex.face(this,p));if(c=l,!c.filter(i).length)break;p=u.map(o).sort(s)[0][1],u.splice(u.indexOf(p),1),u.push(this.idx)}return this.faces.add(c),c.forEach(function(t){return d.pts.forEach(function(n){return t.front(n)?d.setPair(t,n):void 0})}),this}},import$(Convex.prototype,{pair:{f2p:{},p2f:{}},getPair:function(t){return t instanceof Convex.face?this.pair.f2p[this.faces.list.indexOf(t)]||[]:this.pair.p2f[this.pts.indexOf(t)]||[]},setPair:function(t,n){var e,r,i;return((e=(i=this.pair).f2p||(i.f2p={}))[r=this.faces.list.indexOf(t)]||(e[r]=[])).push(n),((e=(i=this.pair).p2f||(i.p2f={}))[r=this.pts.indexOf(n)]||(e[r]=[])).push(t)},faces:{list:[],contain:function(t){return in$(t,this.list)},add:function(t){return Array.isArray(t)?this.list=this.list.concat(t):this.list.push(t)},remove:function(t){var n=this;return Array.isArray(t)||(t=[t]),t.forEach(function(t){var e;return e=n.list.indexOf(t),e>=0?n.list.splice(e,1):void 0})}},polygonReorder:function(t){var n,e,r,i;return n=t.reduce(function(t,n){return t+n.x},0)/t.length,e=t.reduce(function(t,n){return t+n.y},0)/t.length,r=Math.pow(n,2)+Math.pow(e,2),i=function(t){var i,o,s;return i=Math.sqrt(r*(Math.pow(t.x-n,2)+Math.pow(t.y-e,2))),o=Math.acos((-n*(t.x-n)-e*(t.y-e))/i),s=Math.acos((e*(t.x-n)-n*(t.y-e))/i),s>Math.PI/2&&(o=6.28-o),o},t.sort(function(t,n){return i(t)-i(n)})},grid:function(){function t(t,n){return t+n.x}function n(t,n){return t+n.y}var e,r,i,o,s,a,u,c,l,h,f,p,d,x,y,v;for(this.polygons=[],e=0,i=(r=this.pts).length;i>e;++e)o=r[e],o.visited=!1;for(s=[],e=0,i=(r=this.faces.list).length;i>e;++e)if(a=r[e],u=a.center(),a.front({x:u.x,y:u.y,z:-100}))for(c=0,h=(l=a.idx).length;h>c;++c)if(o=l[c],!in$(o,s)){for(s.push(o),f=[],f.idx=o,p=0,x=(d=this.faces.list).length;x>p;++p)y=p,v=d[p],u=v.center(),v.front({x:u.x,y:u.y,z:-100})&&in$(o,v.idx)&&f.push(v.dual());this.polygonReorder(f),f.cx=f.reduce(t,0)/f.length,f.cy=f.reduce(n,0)/f.length,this.pts[o].boundary&&(f.boundary=!0),this.polygons.push(f)}return console.log(this.pts.length,"vs",this.polygons.length)},iterate:function(){function t(t){return t.node[0]===l.node[0]&&t.node[1]===l.node[1]}function n(t){return t.dup=!0,t}var e,r,i,o,s,a,u,c,l,h,f,p,d=this;if(!(this.idx>=this.pts.length)){for(this.faces.list.map(function(t){return t.active=!1}),this.pts[this.idx].active=!0,e=this.getPair(this.pts[this.idx]),r=[],i=0,o=0,s=e.length;s>o;++o)if(a=e[o],this.faces.contain(a))for(u=0;3>u;++u)c=u,i++,l={dup:!1,node:[a.idx[c],a.idx[(c+1)%3]]},l.node[0]>l.node[1]&&l.node.reverse(),h=r.filter(t).map(n),h.length||r.push(l);return f=r.filter(function(t){return!t.dup}).map(function(t){return t.node}),this.faces.remove(e),this.faces.add(p=function(){var t,n,e,r=[];for(t=0,e=(n=f).length;e>t;++t)l=n[t],r.push(new Convex.face(this,l.concat([this.idx]),!0));return r}.call(this)),p.forEach(function(t){return d.pts.forEach(function(n){return t.front(n)?d.setPair(t,n):void 0})}),this.idx++}}}),Convex.face=function(t,n,e){var r,i,o=this;return null==e&&(e=!1),this.convex=t,this.idx=n,this.active=e,this.pts=n.map(function(n){return t.pts[n]}),this.norm=Aux.cross(Aux.sub(this.pts[2],this.pts[0]),Aux.sub(this.pts[1],this.pts[0])),r=["x","y","z"].reduce(function(t,n){return t+Math.pow(o.norm[n],2)},0),this.norm={x:this.norm.x/r,y:this.norm.y/r,z:this.norm.z/r},this.front=function(t){return Aux.inner(this.norm,Aux.sub(t,this.pts[0]))>0},this.center=function(){var t,n=this;return t={x:0,y:0,z:0},this.pts.map(function(e){return t.x+=e.x/n.pts.length,t.y+=e.y/n.pts.length,t.z+=e.z/n.pts.length}),t},i=Aux.inner(this.norm,Aux.sub(t.center,this.pts[0])),i>0?(["x","y","z"].forEach(function(t){return o.norm[t]=-o.norm[t]}),this.pts.reverse(),this.idx.reverse()):0===i&&(this.trivial=!0),this},import$(Convex.face.prototype,{dual:function(){var t,n,e,r,i,o,s,a,u,c,l,h,f,p,d,x,y;return this.dual.value&&this.dual.value,t=this.pts[0],n=t.x,e=t.y,r=t.z,t=this.pts[1],i=t.x,o=t.y,s=t.z,t=this.pts[2],a=t.x,u=t.y,c=t.z,l=e*(s-c)+o*(c-r)+u*(r-s),h=r*(i-a)+s*(a-n)+c*(n-i),f=n*(o-u)+i*(u-e)+a*(e-o),p=n*(o*c-u*s)+i*(u*r-e*c)+a*(e*s-o*r),d=.5*-l/f,x=.5*-h/f,y=-p/f,this.dual.value={x:d,y:x,z:y},this.dual.value}}),$(document).ready(function(){var t,n,e,r,i,o,s,a,u,c,l,h,f,p,d,x,y,v,g,m,z,M,b;for(t=document.getElementById("svg"),n=t.getBoundingClientRect(),e=document.getElementById("svg2"),r=e.getBoundingClientRect(),i=d3.select("#svg").attr({viewBox:[0,0,n.width,n.height].join(" ")}),o=d3.select("#svg2").attr({viewBox:[0,0,r.width,r.height].join(" ")}),s=d3.scale.linear().domain([0,1]).range([40,n.width-40]),a=d3.scale.linear().domain([0,1]).range([n.height-40,40]),u=d3.scale.linear().domain([0,1]).range([3,10]),c=500,l=function(){var t,n,e=[];for(t=0,n=c;n>t;++t)h=t,e.push({x:1*Math.random(),y:1*Math.random(),value:.1*Math.random()+.1});return e}().map(function(t){return t.z=Math.pow(t.x,2)+Math.pow(t.y,2)-0,t}),l=l.concat([{x:0,y:0,boundary:!0},{x:0,y:1,boundary:!0},{x:1,y:0,boundary:!0},{x:1,y:1,boundary:!0}].map(function(t){return t.value=0,t.z=Math.pow(t.x,2)+Math.pow(t.y,2)-t.value,t})),f=new Convex(l),p={x:0,y:0,z:0},d={x:0,y:0,z:0},x=function(){return p={x:0,y:0,z:0},l.forEach(function(t){return p.x+=t.x/l.length,p.y+=t.y/l.length,p.z+=t.z/l.length})},y=function(t){var n,e,r,i,o,s,a,u,c,l,h,f;return n=t.x,e=t.y,r=t.z,n-=p.x,e-=p.y,r-=p.z,i=n,o=e*Math.cos(d.x)+r*Math.sin(d.x),s=-e*Math.sin(d.x)+r*Math.cos(d.x),a=i*Math.cos(d.y)-s*Math.sin(d.y),u=o,c=i*Math.sin(d.y)+s*Math.cos(d.y),l=a*Math.cos(d.z)+u*Math.sin(d.z),h=-a*Math.sin(d.z)+u*Math.cos(d.z),f=c,n=l,e=h,n+=p.x,e+=p.y,r+=p.z,{x:n,y:e,z:r}},v=function(){var t,n,e,r,c,h,p,d,x;return t=i.selectAll("circle.site").data(l),t.enter().append("circle").attr({"class":"site"}),t.exit().remove(),n=i.selectAll("path.polygon").data(f.faces.list),n.enter().append("path").attr({"class":"polygon"}),n.exit().remove(),i.selectAll("circle.site").attr({cx:function(t){var n;return n=y(t),s(n.x)},cy:function(t){var n;return n=y(t),a(n.y)},r:function(t){return u(t.value)},fill:"none",stroke:"#000",opacity:function(){return 1}}),i.selectAll("path.polygon").attr({d:function(t){var n,e,r;return n=y(t.pts[0]),e=y(t.pts[1]),r=y(t.pts[2]),["M"+s(n.x)+" "+a(n.y),"L"+s(e.x)+" "+a(e.y),"L"+s(r.x)+" "+a(r.y),"L"+s(n.x)+" "+a(n.y)].join("")},fill:function(t){var n;return n=t.center(),t.front({x:n.x,y:n.y,z:-100})?"rgba(0,255,0,0.4)":"rgba(255,255,0,0.05)"},stroke:function(t){var n;return n=t.center(),t.front({x:n.x,y:n.y,z:-100})?"rgba(0,92,0,0.4)":"rgba(0,92,0,0.05)"}}),e=i.selectAll("circle.facedual").data(f.faces.list.map(function(t){return{f:t,p:t.dual()}})),e.enter().append("circle").attr({"class":"facedual"}),e.exit().remove(),i.selectAll("circle.facedual").attr({cx:function(t){var n;return n=y(t.p),s(n.x)},cy:function(t){var n;return n=y(t.p),a(n.y)},r:3,fill:"rgba(192,0,0,0.3)",stroke:"#f00",opacity:function(t){var n;return n=t.f.center(),t.f.front({x:n.x,y:n.y,z:-100})?1:.2},"stroke-width":2}),f.polygons?(r=d3.extent(f.polygons.filter(function(t){return!t.boundary}).map(function(t){return t.cx})),c=d3.extent(f.polygons.filter(function(t){return!t.boundary}).map(function(t){return t.cy})),r=[-.5,.5],c=[-.5,.5],h=d3.scale.linear().domain(r).range([50,900]),p=d3.scale.linear().domain(c).range([500,50]),d=o.selectAll("path.voronoi").data(f.polygons||[]),d.enter().append("path").attr({"class":"voronoi"}),d.exit().remove(),o.selectAll("path.voronoi").attr({d:function(t){var n;return["M"+h(t[0].x)+" "+p(t[0].y)].concat(function(){var e,r,i=[];for(e=1,r=t.length;r>e;++e)n=e,i.push("L"+h(t[n].x)+" "+p(t[n].y));return i}(),["L"+h(t[0].x)+" "+p(t[0].y)].join(" "))},fill:"rgba(0,0,0,0.1)",stroke:"#000"}).on("mouseover",function(){return d3.select(this).attr({fill:"rgba(0,0,0,0.5)"})}).on("mouseout",function(){return d3.select(this).attr({fill:"rgba(0,0,0,0.1)"})}),x=o.selectAll("circle.voronoi").data(f.polygons||[]),x.enter().append("circle").attr({"class":"voronoi"}),x.exit().remove(),o.selectAll("circle.voronoi").attr({cx:function(t){return h(t.cx)},cy:function(t){return p(t.cy)},r:function(t){return u(l[t.idx].value)},fill:"rgba(255,0,0,0.2)",stroke:"#f00"})):void 0},g=function(t){return null==t&&(t=0),setTimeout(function(){return f.iterate(),x(),v()},t)},x(),m=(new Date).getTime(),console.log("start: "+m),z=0;c>z;++z)h=z,f.iterate();return M=(new Date).getTime(),console.log("grid: "+M+" ( elapsed: "+(M-m)+")"),f.grid(),b=(new Date).getTime(),console.log("end: "+b),console.log("elapsed: "+(b-M)+" / total: "+(b-m)),setInterval(function(){return d.y=d.y+0,d.z=d.z+0,v()},1e3)});