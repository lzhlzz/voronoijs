function import$(t,n){var e={}.hasOwnProperty;for(var r in n)e.call(n,r)&&(t[r]=n[r]);return t}function in$(t,n){for(var e=-1,r=n.length>>>0;++e<r;)if(t===n[e])return!0;return!1}var Aux,Convex;Aux={inner:function(t,n){return["x","y","z"].map(function(e){return t[e]*n[e]}).reduce(function(t,n){return t+n},0)},side:function(t,n){var e;return e=this.inner(t.norm,n)},sub:function(t,n){var e;return e={},["x","y","z"].map(function(r){return e[r]=t[r]-n[r]}),e},cross:function(t,n){return{x:t.y*n.z-t.z*n.y,y:t.z*n.x-t.x*n.z,z:t.x*n.y-t.y*n.x}}},Convex=function(t,n){function e(t){return d.center[t]=[0,1,2,3].reduce(function(n,e){return n+d.pts[u[e]][t]},0)/4}function r(t){return t.map(function(t){return u[t]})}function i(t){return t.trivial}function o(t,n){var e;return e=Aux.sub(d.center,d.pts[t]),["x","y","z"].reduce(function(t,n){return t+Math.pow(e[n],2)},0),[e,n]}function s(t,n){return t[0]-n[0]}var a,u,c,h,l,f,p,d=this;if(this.pts=t,this.debug=n,this.faces.list=[],this.debug&&console.log("Create convex for point set ( length "+t.length+" )"),!(this.pts.length<4)){for(a=[[0,1,2,3],3],u=a[0],this.idx=a[1];this.idx<this.pts.length;){for(this.idx++,this.center={},["x","y","z"].map(e),h=[],l=0,f=(a=[[0,1,2],[0,1,3],[0,2,3],[1,2,3]].map(r)).length;f>l;++l)p=a[l],h.push(new Convex.face(this,p));if(c=h,!c.filter(i).length)break;p=u.map(o).sort(s)[0][1],u.splice(u.indexOf(p),1),u.push(this.idx)}return this.faces.add(c),c.forEach(function(t){return d.pts.forEach(function(n){return t.front(n)?d.setPair(t,n):void 0})}),this}},import$(Convex.prototype,{pair:{f2p:{},p2f:{}},getPair:function(t){return t instanceof Convex.face?this.pair.f2p[this.faces.list.indexOf(t)]||[]:this.pair.p2f[this.pts.indexOf(t)]||[]},setPair:function(t,n){var e,r,i;return((e=(i=this.pair).f2p||(i.f2p={}))[r=this.faces.list.indexOf(t)]||(e[r]=[])).push(n),((e=(i=this.pair).p2f||(i.p2f={}))[r=this.pts.indexOf(n)]||(e[r]=[])).push(t)},faces:{list:[],contain:function(t){return in$(t,this.list)},add:function(t){return Array.isArray(t)?this.list=this.list.concat(t):this.list.push(t)},remove:function(t){var n=this;return Array.isArray(t)||(t=[t]),t.forEach(function(t){var e;return e=n.list.indexOf(t),e>=0?n.list.splice(e,1):void 0})}},polygonReorder:function(t){var n,e,r,i;return n=t.reduce(function(t,n){return t+n.x},0)/t.length,e=t.reduce(function(t,n){return t+n.y},0)/t.length,r=Math.pow(n,2)+Math.pow(e,2),i=function(t){var i,o,s;return i=Math.sqrt(r*(Math.pow(t.x-n,2)+Math.pow(t.y-e,2))),o=Math.acos((-n*(t.x-n)-e*(t.y-e))/i),s=Math.acos((e*(t.x-n)-n*(t.y-e))/i),s>Math.PI/2&&(o=6.28-o),o},t.sort(function(t,n){return i(t)-i(n)})},grid:function(){function t(t,n){return t+n.x}function n(t,n){return t+n.y}var e,r,i,o,s,a,u,c,h,l,f,p,d,x,y,v;for(this.polygons=[],e=0,i=(r=this.pts).length;i>e;++e)o=r[e],o.visited=!1;for(s=[],e=0,i=(r=this.faces.list).length;i>e;++e)if(a=r[e],u=a.center(),a.front({x:u.x,y:u.y,z:-100}))for(c=0,l=(h=a.idx).length;l>c;++c)if(o=h[c],!in$(o,s)){for(s.push(o),f=[],f.idx=o,p=0,x=(d=this.faces.list).length;x>p;++p)y=p,v=d[p],u=v.center(),v.front({x:u.x,y:u.y,z:-100})&&in$(o,v.idx)&&f.push(v.dual());this.polygonReorder(f),f.cx=f.reduce(t,0)/f.length,f.cy=f.reduce(n,0)/f.length,this.pts[o].boundary&&(f.boundary=!0),this.polygons.push(f)}return console.log(this.pts.length,"vs",this.polygons.length)},iterate:function(){function t(t){return t.node[0]===h.node[0]&&t.node[1]===h.node[1]}function n(t){return t.dup=!0,t}var e,r,i,o,s,a,u,c,h,l,f,p,d=this;if(!(this.idx>=this.pts.length)){for(this.faces.list.map(function(t){return t.active=!1}),this.pts[this.idx].active=!0,e=this.getPair(this.pts[this.idx]),r=[],i=0,o=0,s=e.length;s>o;++o)if(a=e[o],this.faces.contain(a))for(u=0;3>u;++u)c=u,i++,h={dup:!1,node:[a.idx[c],a.idx[(c+1)%3]]},h.node[0]>h.node[1]&&h.node.reverse(),l=r.filter(t).map(n),l.length||r.push(h);return f=r.filter(function(t){return!t.dup}).map(function(t){return t.node}),this.faces.remove(e),this.faces.add(p=function(){var t,n,e,r=[];for(t=0,e=(n=f).length;e>t;++t)h=n[t],r.push(new Convex.face(this,h.concat([this.idx]),!0));return r}.call(this)),p.forEach(function(t){return d.pts.forEach(function(n){return t.front(n)?d.setPair(t,n):void 0})}),this.idx++}}}),Convex.face=function(t,n,e){var r,i,o=this;return null==e&&(e=!1),this.convex=t,this.idx=n,this.active=e,this.pts=n.map(function(n){return t.pts[n]}),this.norm=Aux.cross(Aux.sub(this.pts[2],this.pts[0]),Aux.sub(this.pts[1],this.pts[0])),r=["x","y","z"].reduce(function(t,n){return t+Math.pow(o.norm[n],2)},0),this.norm={x:this.norm.x/r,y:this.norm.y/r,z:this.norm.z/r},this.front=function(t){return Aux.inner(this.norm,Aux.sub(t,this.pts[0]))>0},this.center=function(){var t,n=this;return t={x:0,y:0,z:0},this.pts.map(function(e){return t.x+=e.x/n.pts.length,t.y+=e.y/n.pts.length,t.z+=e.z/n.pts.length}),t},i=Aux.inner(this.norm,Aux.sub(t.center,this.pts[0])),i>0?(["x","y","z"].forEach(function(t){return o.norm[t]=-o.norm[t]}),this.pts.reverse(),this.idx.reverse()):0===i&&(this.trivial=!0),this},import$(Convex.face.prototype,{dual:function(){var t,n,e,r,i,o,s,a,u,c,h,l,f,p,d,x,y;return this.dual.value&&this.dual.value,t=this.pts[0],n=t.x,e=t.y,r=t.z,t=this.pts[1],i=t.x,o=t.y,s=t.z,t=this.pts[2],a=t.x,u=t.y,c=t.z,h=e*(s-c)+o*(c-r)+u*(r-s),l=r*(i-a)+s*(a-n)+c*(n-i),f=n*(o-u)+i*(u-e)+a*(e-o),p=n*(o*c-u*s)+i*(u*r-e*c)+a*(e*s-o*r),d=.5*-h/f,x=.5*-l/f,y=-p/f,this.dual.value={x:d,y:x,z:y},this.dual.value}}),$(document).ready(function(){var t,n,e,r,i,o,s,a,u,c,h,l,f,p,d,x,y,v,g,m,M,z,b,w,A,C,I,P,E,B,$,k,L,O,j,R;for(t=document.getElementById("svg"),n=t.getBoundingClientRect(),e=d3.select("#svg").attr({viewBox:[0,0,n.width,n.height].join(" ")}),r=document.getElementById("svg2"),i=r.getBoundingClientRect(),o=d3.select("#svg2").attr({viewBox:[0,0,i.width,i.height].join(" ")}),s=document.getElementById("svg3"),a=s.getBoundingClientRect(),u=d3.select("#svg3").attr({viewBox:[0,0,i.width,i.height].join(" ")}),c=d3.scale.linear().domain([0,1]).range([40,n.width-40]),h=d3.scale.linear().domain([0,1]).range([n.height-40,40]),l=d3.scale.linear().domain([0,1]).range([3,10]),f=50,p=function(){var t,n,e=[];for(t=0,n=f;n>t;++t)d=t,e.push({x:1*Math.random(),y:1*Math.random(),value:1});return e}().map(function(t){return t.z=Math.pow(t.x,2)+Math.pow(t.y,2)-t.value,t}),x=p.reduce(function(t,n){return t+n.value},0),p.map(function(t){return t.value=t.value/x}),p=p.concat([{x:0,y:0,boundary:!0},{x:0,y:1,boundary:!0},{x:1,y:0,boundary:!0},{x:1,y:1,boundary:!0}].map(function(t){return t.value=0,t.z=Math.pow(t.x,2)+Math.pow(t.y,2)-t.value,t})),y=new Convex(p),v={x:0,y:0,z:0},g={x:0,y:0,z:0},m=function(){return v={x:0,y:0,z:0},p.forEach(function(t){return v.x+=t.x/p.length,v.y+=t.y/p.length,v.z+=t.z/p.length})},M=function(t){var n,e,r,i,o,s,a,u,c,h,l,f;return n=t.x,e=t.y,r=t.z,n-=v.x,e-=v.y,r-=v.z,i=n,o=e*Math.cos(g.x)+r*Math.sin(g.x),s=-e*Math.sin(g.x)+r*Math.cos(g.x),a=i*Math.cos(g.y)-s*Math.sin(g.y),u=o,c=i*Math.sin(g.y)+s*Math.cos(g.y),h=a*Math.cos(g.z)+u*Math.sin(g.z),l=-a*Math.sin(g.z)+u*Math.cos(g.z),f=c,n=h,e=l,n+=v.x,e+=v.y,r+=v.z,{x:n,y:e,z:r}},z=function(){var t,n,r,i,s,a,u,f,d,x,v,g,m,z;if(t=e.selectAll("circle.site").data(p),t.enter().append("circle").attr({"class":"site"}),t.exit().remove(),n=e.selectAll("path.polygon").data(y.faces.list),n.enter().append("path").attr({"class":"polygon"}),n.exit().remove(),e.selectAll("circle.site").attr({cx:function(t){var n;return n=M(t),c(n.x)},cy:function(t){var n;return n=M(t),h(n.y)},r:function(t){return l(t.value)},fill:"none",stroke:"#000",opacity:function(){return 1}}),e.selectAll("path.polygon").attr({d:function(t){var n,e,r;return n=M(t.pts[0]),e=M(t.pts[1]),r=M(t.pts[2]),["M"+c(n.x)+" "+h(n.y),"L"+c(e.x)+" "+h(e.y),"L"+c(r.x)+" "+h(r.y),"L"+c(n.x)+" "+h(n.y)].join("")},fill:function(t){var n;return n=t.center(),t.front({x:n.x,y:n.y,z:-100})?"rgba(0,255,0,0.4)":"rgba(255,255,0,0.05)"},stroke:function(t){var n;return n=t.center(),t.front({x:n.x,y:n.y,z:-100})?"rgba(0,92,0,0.4)":"rgba(0,92,0,0.05)"}}),r=e.selectAll("circle.facedual").data(y.faces.list.map(function(t){return{f:t,p:t.dual()}})),r.enter().append("circle").attr({"class":"facedual"}),r.exit().remove(),e.selectAll("circle.facedual").attr({cx:function(t){var n;return n=M(t.p),c(n.x)},cy:function(t){var n;return n=M(t.p),h(n.y)},r:3,fill:"rgba(192,0,0,0.3)",stroke:"#f00",opacity:function(t){var n;return n=t.f.center(),t.f.front({x:n.x,y:n.y,z:-100})?1:.2},"stroke-width":2}),y.polygons){for(i=y.polygons,s=60,u=[],f=0;s>f;++f)d=f,u.push({x:1*(.5+.7*Math.cos(2*Math.PI*d/s)),y:1*(.5+.7*Math.sin(2*Math.PI*d/s))});return a=u,i=i.map(function(t){return PolygonIntersect(a,t)}),x=[-1.5,1.5],v=[-1.5,1.5],g=d3.scale.linear().domain(x).range([50,900]),m=d3.scale.linear().domain(v).range([500,50]),z=o.selectAll("path.voronoi").data(i||[]),z.enter().append("path").attr({"class":"voronoi"}),z.exit().remove(),o.selectAll("path.voronoi").attr({d:function(t){var n;return t.length?["M"+g(t[0].x)+" "+m(t[0].y)].concat(function(){var e,r,i=[];for(e=1,r=t.length;r>e;++e)n=e,i.push("L"+g(t[n].x)+" "+m(t[n].y));return i}(),["L"+g(t[0].x)+" "+m(t[0].y)].join(" ")):""},fill:"rgba(0,0,0,0.1)",stroke:"#000"}).on("mouseover",function(){return d3.select(this).attr({fill:"rgba(0,0,0,0.5)"})}).on("mouseout",function(){return d3.select(this).attr({fill:"rgba(0,0,0,0.1)"})})}},b=function(t){return null==t&&(t=0),setTimeout(function(){return y.iterate(),m(),z()},t)},m(),w=(new Date).getTime(),console.log("start: "+w),A=0;f>A;++A)d=A,y.iterate();return C=(new Date).getTime(),console.log("grid: "+C+" ( elapsed: "+(C-w)+")"),y.grid(),I=(new Date).getTime(),console.log("end: "+I),console.log("elapsed: "+(I-C)+" / total: "+(I-w)),setInterval(function(){return g.y=g.y+0,g.z=g.z+0,z()},1e3),P=function(t,n,e,r){var i,o,s,a;for(i=[],o=0;r>=o;++o)s=o,a=2*Math.PI*s/r,i.push({x:t+Math.cos(a)*e,y:n+Math.sin(a)*e});return i},E=function(t,n,e,r){var i,o,s;return null==t&&(t=1),null==n&&(n=1),null==e&&(e=6),null==r&&(r=6),i=P(2,1.5,.5,e),o=P(t,n,.5,r),s=PolygonIntersect(i,o),s.active=!0,u.selectAll("path").data([i,o,s]).enter().append("path"),u.selectAll("path").attr({d:function(t){var n;return t.length?["M"+200*t[0].x+" "+200*t[0].y].concat(function(){var e,r,i=[];for(e=1,r=t.length;r>e;++e)n=e,i.push("L"+200*t[n].x+" "+200*t[n].y);return i}(),["L"+200*t[0].x+" "+200*t[0].y].join(" ")):""},fill:function(t){return t.active?"rgba(255,0,0,0.3)":"rgba(0,0,0,0.1)"},stroke:function(t){return t.active?"rgba(255,0,0,0.9)":"rgba(0,0,0,0.5)"}})},B=2,$=1.5,k=0,L=1,O=0,j=0,R=0,setInterval(function(){var t,n;return t=B+L*Math.cos(k),n=$+L*Math.sin(k),E(t,n,6+parseInt(4*Math.cos(j)),6+parseInt(4*Math.sin(R))),L=Math.sin(O),O+=.02,k+=.03,j+=.01,R+=.02},10)});