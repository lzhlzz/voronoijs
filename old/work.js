function import$(t,n){var e={}.hasOwnProperty;for(var r in n)e.call(n,r)&&(t[r]=n[r]);return t}function in$(t,n){for(var e=-1,r=n.length>>>0;++e<r;)if(t===n[e])return!0;return!1}var Aux,Convex;Aux={inner:function(t,n){return["x","y","z"].map(function(e){return t[e]*n[e]}).reduce(function(t,n){return t+n},0)},side:function(t,n){var e;return e=this.inner(t.norm,n)},sub:function(t,n){var e;return e={},["x","y","z"].map(function(r){return e[r]=t[r]-n[r]}),e},cross:function(t,n){return{x:t.y*n.z-t.z*n.y,y:t.z*n.x-t.x*n.z,z:t.x*n.y-t.y*n.x}}},Convex=function(t,n){function e(t){return p.center[t]=[0,1,2,3].reduce(function(n,e){return n+p.pts[a[e]][t]},0)/4}function r(t){return t.map(function(t){return a[t]})}function i(t){return t.trivial}function s(t,n){var e;return e=Aux.sub(p.center,p.pts[t]),["x","y","z"].reduce(function(t,n){return t+Math.pow(e[n],2)},0),[e,n]}function o(t,n){return t[0]-n[0]}var u,a,c,h,f,l,x,p=this;if(this.pts=t,this.debug=n,this.faces.list=[],this.debug&&console.log("Create convex for point set ( length "+t.length+" )"),!(this.pts.length<4)){for(u=[[0,1,2,3],3],a=u[0],this.idx=u[1];this.idx<this.pts.length;){for(this.idx++,this.center={},["x","y","z"].map(e),h=[],f=0,l=(u=[[0,1,2],[0,1,3],[0,2,3],[1,2,3]].map(r)).length;l>f;++f)x=u[f],h.push(new Convex.face(this,x));if(c=h,!c.filter(i).length)break;x=a.map(s).sort(o)[0][1],a.splice(a.indexOf(x),1),a.push(this.idx)}return this.faces.add(c),c.forEach(function(t){return p.pts.forEach(function(n){return t.front(n)?p.setPair(t,n):void 0})}),this}},import$(Convex.prototype,{pair:{f2p:{},p2f:{}},getPair:function(t){return t instanceof Convex.face?this.pair.f2p[this.faces.list.indexOf(t)]||[]:this.pair.p2f[this.pts.indexOf(t)]||[]},setPair:function(t,n){var e,r,i;return((e=(i=this.pair).f2p||(i.f2p={}))[r=this.faces.list.indexOf(t)]||(e[r]=[])).push(n),((e=(i=this.pair).p2f||(i.p2f={}))[r=this.pts.indexOf(n)]||(e[r]=[])).push(t)},faces:{list:[],contain:function(t){return in$(t,this.list)},add:function(t){return Array.isArray(t)?this.list=this.list.concat(t):this.list.push(t)},remove:function(t){var n=this;return Array.isArray(t)||(t=[t]),t.forEach(function(t){var e;return e=n.list.indexOf(t),e>=0?n.list.splice(e,1):void 0})}},iterate:function(){function t(t){return t.node[0]===h.node[0]&&t.node[1]===h.node[1]}function n(t){return t.dup=!0,t}var e,r,i,s,o,u,a,c,h,f,l,x,p=this;if(console.log(this.idx),!(this.idx>=this.pts.length)){for(this.faces.list.map(function(t){return t.active=!1}),this.pts[this.idx].active=!0,e=this.getPair(this.pts[this.idx]),r=[],i=0,s=0,o=e.length;o>s;++s)if(u=e[s],this.faces.contain(u))for(a=0;3>a;++a)c=a,i++,h={dup:!1,node:[u.idx[c],u.idx[(c+1)%3]]},h.node[0]>h.node[1]&&h.node.reverse(),f=r.filter(t).map(n),f.length||r.push(h);return l=r.filter(function(t){return!t.dup}).map(function(t){return t.node}),console.log("edges: ",r.length),console.log("remove: ",e.length),this.faces.remove(e),this.faces.add(x=function(){var t,n,e,r=[];for(t=0,e=(n=l).length;e>t;++t)h=n[t],r.push(new Convex.face(this,h.concat([this.idx]),!0));return r}.call(this)),console.log("add: ",l.length),x.forEach(function(t){return p.pts.forEach(function(n){return t.front(n)?p.setPair(t,n):void 0})}),this.idx++}}}),Convex.face=function(t,n,e){var r,i,s=this;return null==e&&(e=!1),this.convex=t,this.idx=n,this.active=e,this.pts=n.map(function(n){return t.pts[n]}),this.norm=Aux.cross(Aux.sub(this.pts[2],this.pts[0]),Aux.sub(this.pts[1],this.pts[0])),r=["x","y","z"].reduce(function(t,n){return t+Math.pow(s.norm[n],2)},0),this.norm={x:this.norm.x/r,y:this.norm.y/r,z:this.norm.z/r},this.front=function(t){return Aux.inner(this.norm,Aux.sub(t,this.pts[0]))>0},i=Aux.inner(this.norm,Aux.sub(t.center,this.pts[0])),i>0?(["x","y","z"].forEach(function(t){return s.norm[t]=-s.norm[t]}),this.pts.reverse(),this.idx.reverse()):0===i&&(this.trivial=!0),this},$(document).ready(function(){var t,n,e,r,i,s,o,u,a,c,h,f,l,x,p;return t=document.getElementById("svg"),n=t.getBoundingClientRect(),e=d3.select("#svg").attr({viewBox:[0,0,n.width,n.height].join(" ")}),r=d3.scale.linear().range([40,n.width-40]),i=d3.scale.linear().range([n.height-40,40]),s=d3.scale.linear().range([10,100]),o=[{x:300,y:400,z:200,value:10},{x:900,y:400,z:200,value:10},{x:900,y:400,z:400,value:10},{x:300,y:400,z:400,value:10},{x:600,y:200,z:300,value:10},{x:600,y:600,z:300,value:10}],o=function(){var t,n,e=[];for(t=0,n=6.28/12;0>n?t>6.28:6.28>t;t+=n)u=t,e.push(u);return e}().map(function(t){return{x:600+200*Math.cos(t),y:300+30*(t%2)-15,z:400+200*Math.sin(t),value:10}}).concat([{x:600,y:150,z:400,value:10},{x:600,y:450,z:400,value:10}]),a=new Convex(o),c={x:0,y:0,z:0},h={x:0,y:0,z:0},f=function(){return c={x:0,y:0,z:0},o.forEach(function(t){return c.x+=t.x/o.length,c.y+=t.y/o.length,c.z+=t.z/o.length})},l=function(t){var n,e,r;return n=t.x,e=t.y,r=t.z,n-=c.x,e-=c.y,r-=c.z,e=e*Math.cos(h.x)+r*Math.sin(h.x),r=-e*Math.sin(h.x)+r*Math.cos(h.x),n=n*Math.cos(h.y)-r*Math.sin(h.y),r=n*Math.sin(h.y)+r*Math.cos(h.y),n+=c.x,e+=c.y,r+=c.z,{x:n,y:e,z:r}},x=function(){var t,n;return t=e.selectAll("circle.site").data(o),t.enter().append("circle").attr({"class":"site"}),t.exit().remove(),n=e.selectAll("path.polygon").data(a.faces.list),n.enter().append("path").attr({"class":"polygon"}),n.exit().remove(),e.selectAll("circle.site").attr({cx:function(t){var n;return n=l(t),n.x},cy:function(t){var n;return n=l(t),n.y},r:function(t){return t.value},fill:function(t){return t.active?"rgba(255,0,0,0.6)":"rgba(0,0,0,0.2)"},stroke:"#000",opacity:function(t){return 1-t.z/500}}),e.selectAll("path.polygon").attr({d:function(t){var n,e,r;return n=l(t.pts[0]),e=l(t.pts[1]),r=l(t.pts[2]),["M"+n.x+" "+n.y,"L"+e.x+" "+e.y,"L"+r.x+" "+r.y,"L"+n.x+" "+n.y].join("")},fill:"rgba(0,255,0,0.2)",stroke:"rgba(0,92,0,0.6)"})},p=function(t){return null==t&&(t=0),setTimeout(function(){return a.iterate(),f(),x()},t)},x(),f(),p(1e3),p(2e3),p(3e3),p(4e3),p(5e3),p(6e3),p(7e3),p(8e3),p(9e3),p(1e4),p(11e3),setInterval(function(){return h.y=h.y+.015,h.x=.1,x()},100)});